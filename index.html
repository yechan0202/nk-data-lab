<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>NK Data Lab</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    h1 { color: #222; }
    .section { margin-top: 30px; }
    .card { padding: 15px; border: 1px solid #ddd; margin-top: 10px; border-radius: 8px; }
    a { color: #0366d6; text-decoration: none; }
    a:hover { text-decoration: underline; }
    ul { padding-left: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #eee; padding: 8px; font-size: 13px; }
    th { background: #f8f8f8; }
    .controls { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    input, select, button { padding: 6px 8px; font-size: 13px; }
  </style>
</head>
<body>
<h1>North Korea Data Lab</h1>
<p>Interactive access to structured datasets on DPRK sanctions, diplomacy, and related domains.</p>

<div class="section">
  <h2>Sanctions Timeline Panel (2006–Present)</h2>
  <p>Monthly coded UN Security Council sanctions resolutions affecting DPRK (in-browser filterable table). Each row is sourced from the UN 1718 Sanctions Committee resolutions list (see link column).</p>
  <div class="controls">
    <select id="filter-year"><option value="">Year</option></select>
    <input id="filter-resolution" placeholder="Resolution (e.g., 2397)" />
    <input id="search" placeholder="Search text (e.g., oil)" />
    <button id="reset" type="button">Reset</button>
  </div>
  <table>
    <thead>
      <tr>
        <th>Year</th>
        <th>Month</th>
        <th>Resolution</th>
        <th>Sanction type</th>
        <th>Target sector</th>
        <th>New/expansion</th>
        <th>Source</th>
      </tr>
    </thead>
    <tbody id="table-body">
      <tr><td colspan="7">Loading...</td></tr>
    </tbody>
  </table>
  <p><small>Source: <a href="https://www.un.org/securitycouncil/sanctions/1718/resolutions">UN Security Council 1718 Sanctions Committee resolutions list</a>.</small></p>
</div>

<div class="section">
  <h2>Other data sources (to be integrated next)</h2>
  <ul>
    <li>Trade: UN Comtrade (DPRK trade flows)</li>
    <li>Night lights: VIIRS (NOAA)</li>
    <li>Military launches: CSIS Missile Threat</li>
    <li>Humanitarian finance: UN OCHA / FTS</li>
  </ul>
</div>

<script>
function normalizeKey(k){
  return k ? k.replace(/^﻿/, '').trim().toLowerCase() : '';
}

function normalizeRow(raw){
  const out = {};
  for (const key in raw){
    const nk = normalizeKey(key);
    out[nk] = (raw[key] ?? '').toString().trim();
  }
  return out;
}

function safeString(v){
  return v === undefined || v === null ? '' : String(v);
}

function containsText(haystack, needle){
  haystack = safeString(haystack).toLowerCase();
  needle = safeString(needle).toLowerCase();
  return haystack.includes(needle);
}

const yearSelect = document.getElementById('filter-year');
const resInput = document.getElementById('filter-resolution');
const searchInput = document.getElementById('search');
const resetBtn = document.getElementById('reset');
const tbody = document.getElementById('table-body');

let data = [];
let yearList = [];

function render(rows){
  tbody.innerHTML = '';
  if (rows.length === 0){
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 7;
    td.textContent = 'No matches.';
    tr.appendChild(td);
    tbody.appendChild(tr);
    return;
  }

  for (const row of rows){
    const tr = document.createElement('tr');
    const link = row.source_url ? `<a href="${row.source_url}">link</a>` : '';
    tr.innerHTML = `
      <td>${row.year}</td>
      <td>${row.month}</td>
      <td>${row.resolution}</td>
      <td>${row.sanction_type}</td>
      <td>${row.target_sector}</td>
      <td>${row.new_or_expansion}</td>
      <td>${link}</td>
    `;
    tbody.appendChild(tr);
  }
}

function applyFilters(){
  const year = yearSelect.value;
  const res = resInput.value.trim();
  const q = searchInput.value.trim();

  const rows = data.filter((row) => {
    if (year && row.year !== year) return false;
    if (res && !containsText(row.resolution, res)) return false;
    if (q){
      const hay = `${row.sanction_type} ${row.target_sector} ${row.new_or_expansion} ${row.resolution}`;
      if (!containsText(hay, q)) return false;
    }
    return true;
  });

  render(rows);
}

function initYearOptions(){
  yearSelect.innerHTML = '<option value="">Year</option>';
  yearList.sort((a,b)=>a-b);
  for (const y of yearList){
    const opt = document.createElement('option');
    opt.value = String(y);
    opt.textContent = String(y);
    yearSelect.appendChild(opt);
  }
}

function ingestRows(rawRows){
  const out = [];
  const yearSet = new Set();
  for (const raw of rawRows){
    const row = normalizeRow(raw);
    if (!row.year) continue;
    const yr = parseInt(row.year, 10);
    if (!Number.isNaN(yr)) yearSet.add(yr);
    out.push(row);
  }
  yearList = Array.from(yearSet);
  return out;
}

Papa.parse('data/sanctions_timeline_panel.csv', {
  download: true,
  header: true,
  skipEmptyLines: true,
  complete: (results) => {
    data = ingestRows(results.data);
    initYearOptions();
    applyFilters();
  },
  error: (err) => {
    tbody.innerHTML = '<tr><td colspan="7">Failed to load CSV.</td></tr>';
    console.error(err);
  },
});

yearSelect.addEventListener('change', applyFilters);
resInput.addEventListener('input', applyFilters);
searchInput.addEventListener('input', applyFilters);
resetBtn.addEventListener('click', () => {
  yearSelect.value = '';
  resInput.value = '';
  searchInput.value = '';
  applyFilters();
});
</script>
</body>
</html>
